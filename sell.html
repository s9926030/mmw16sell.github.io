<!DOCTYPE html>
<html lang="zh-Hant">

<head>
  <meta charset="UTF-8" />
  <title data-i18n="title">路人 vs 百業 交易漲幅試算</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --items-gap: 0px;
      --items-padding: 0px;
      --max-content-width: 100%;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      color: #222;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
      max-width: var(--max-content-width);
      margin: 0px auto 0;
      padding: 0 12px;
      box-sizing: border-box;
    }

    .title {
      text-align: center;
      font-size: 36px;
      font-weight: 700;
    }

    .items-fullbleed {
      width: 100vw;
      position: relative;
      left: 50%;
      right: 50%;
      margin-left: -50vw;
      margin-right: -50vw;
      padding: var(--items-padding) 12px;
      background: #ffffff;
      border-radius: 0;
      box-shadow: none;
      box-sizing: border-box;
    }

    .items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--items-gap);
      align-items: stretch;
    }

    .item {
      background: #fafafa;
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 80px;
      transition: transform 180ms cubic-bezier(.2, .9, .2, 1), box-shadow 180ms ease;
    }

    .item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .item.active {
      transform: scale(1.06);
      border: 2px solid #ff0000;
      box-shadow: 0 12px 30px rgba(255, 87, 34, 0.18);
    }

    .items-cost {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: center;
      flex-wrap: nowrap;
      max-width: var(--max-content-width);
      margin: 12px auto 0;
      padding: 0 12px;
      box-sizing: border-box;
    }

    .items-cost .label {
      white-space: nowrap;
      flex: 0 0 auto;
      margin-right: 6px;
    }

    .items-cost input {
      width: 350px;
      min-width: 0;
    }

    .calc-wrapper {
      margin-top: 18px;
    }

    .calc-box {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .box {
      background: #fff;
      padding: 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
      box-sizing: border-box;
    }

    .box.small {
      width: 360px;
      max-width: 100%;
    }

    label {
      display: block;
      margin-top: 10px;
      font-size: 14px;
    }

    input {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      box-sizing: border-box;
      font-size: 14px;
    }

    .result {
      margin-top: 8px;
      font-weight: 700;
    }

    .highlight {
      color: red;
    }

    .lang-switch {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 999;
      display: flex;
      gap: 8px;
    }

    .lang-switch button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fff;
      cursor: pointer;
    }

    .lang-switch button.active {
      background: #222;
      color: #fff;
      border-color: #222;
    }

    @media (max-width:900px) {
      .items-fullbleed {
        padding: 8px;
      }

      .items {
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 8px;
      }

      .calc-box {
        flex-direction: column;
      }

      .title {
        font-size: 28px;
      }
    }
  </style>
</head>

<body>
  <!-- 語言切換按鈕 -->
  <div class="lang-switch" aria-hidden="false">
    <label data-i18n="ai_label">網頁製作人：AI</label>
    <button id="btn-zh" data-lang="zh-TW">中文</button>
    <button id="btn-en" data-lang="en">English</button>
  </div>

  <!-- 標題置中（在 container 內） -->
  <div class="container">
    <div class="title" data-i18n="title">路人 vs 百業 交易漲幅對比</div>
  </div>

  <!-- items 區：full-bleed（撐滿視窗左右） -->
  <div class="items-fullbleed" id="itemsFull">
    <div class="items" id="items"></div>
  </div>

  <!-- 計算區（置中 container） -->
  <div class="items-cost">
    <div class="label" data-i18n="cost_label">成本</div>
    <input id="cost" type="number" data-i18n-placeholder="cost_placeholder" placeholder="選擇物品 或 手動輸入（點擊自動填入成本）" />
  </div>

  <div class="container">
    <div class="calc-wrapper">
      <div class="calc-box">
        <div class="box small">
          <h2 data-i18n="r_title" style="margin:0 0 8px 0;">路人交易</h2>
          <div style="font-weight:700; margin-bottom:6px;" id="baUp"></div>
          <label data-i18n="r_sell_label">成交價</label>
          <input id="sell_r" type="number" step="1" value="280" />
          <label data-i18n="r_markup_label">漲幅 (%)</label>
          <input id="markup_r" type="number" value="300" />
          <div id="baUp2" class="result" style="font-weight:400; margin-top:6px;"></div>
          <div class="result" id="result_r"></div>
        </div>

        <div class="box small">
          <h2 data-i18n="b_title" style="margin:0 0 8px 0;">百業交易</h2>
          <label data-i18n="b_markup_label">漲幅 (%)</label>
          <input id="markup_b" type="number" value="0" />
          <label data-i18n="b_tax_label">市買稅 (%)（滿等=1）</label>
          <input id="tax_b" type="number" value="1" step="0.5" />
          <label data-i18n="b_bonus_label">短陌錢加成 (%)（滿等=14.5）</label>
          <input id="bonus_b" type="number" value="14.5" step="0.5" />
          <div class="result" id="result_b"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- translations（中/英） ---------- */
    const translations = {
      "zh-TW": {
        "title": "路人 vs 百業 交易漲幅對比",
        "cost_label": "成本",
        "cost_placeholder": "選擇物品 或 手動輸入（點擊自動填入成本）",
        "r_title": "路人交易",
        "r_sell_label": "成交價",
        "r_markup_label": "漲幅 (%)",
        "b_title": "百業交易",
        "b_markup_label": "漲幅 (%)",
        "b_tax_label": "市買稅 (%)（滿等=1）",
        "b_bonus_label": "短陌錢加成 (%)（滿等=14.5）",
        "ba_equal_cost": "等同百業漲幅 ≈ 請輸入成本",
        "ba_check": "請確認成本、稅率與加成是否正確（不可為 0 ）",
        "sell_info_r": "成交價：{price}<br>實際價格：<span class=\"{cls}\">{income}</span>　市買稅 -11%",
        "sell_info_b": "成交價：{price}<br>實際價格：<span class=\"{cls}\">{income}</span>",
        "ba_basis": "依據：百業稅率 {tax}%，短陌錢加成 {bonus}%",
        "ai_label": "製作人：AI"
      },
      "en": {
        "title": "Passerby vs Guild Price Fluctuation Comparison",
        "cost_label": "Cost",
        "cost_placeholder": "Select item or enter manually (click to autofill cost)",
        "r_title": "Passerby Trade",
        "r_sell_label": "Sell Price",
        "r_markup_label": "Fluctuation (%)",
        "b_title": "Guild Trade",
        "b_markup_label": "Fluctuation (%)",
        "b_tax_label": "Market Tax (%) (Full=1)",
        "b_bonus_label": "Commerce Coins Acquisition Efficiency (%) (Full=14.5)",
        "ba_equal_cost": "Equivalent Guild Fluctuation ≈ please enter cost",
        "ba_check": "Please check cost, tax and bonus are valid (not 0)",
        "sell_info_r": "Sell price: {price}<br>Net price: <span class=\"{cls}\">{income}</span>　Market tax -11%",
        "sell_info_b": "Sell price: {price}<br>Net price: <span class=\"{cls}\">{income}</span>",
        "ba_basis": "Based on: Market Tax {tax}%, Commerce Coins Acquisition Efficiency {bonus}%",
        "ai_label": "Creator：AI"
      }
    };

    // 目前語言（從 localStorage 或預設）
    let currentLang = localStorage.getItem('lang') || 'zh-TW';

    // 取翻譯並替換 {var}
    function t(key, vars = {}) {
      const dict = translations[currentLang] || translations['zh-TW'];
      let str = dict[key] || key;
      Object.keys(vars).forEach(k => {
        str = str.replaceAll(`{${k}}`, vars[k]);
      });
      return str;
    }

    // 套用靜態翻譯（data-i18n / data-i18n-placeholder / data-i18n-title）
    function applyTranslations() {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        el.innerHTML = t(key);
      });
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
        const key = el.getAttribute('data-i18n-placeholder');
        el.placeholder = t(key);
      });
      // title 屬性（例如 <title>）
      document.querySelectorAll('[data-i18n-title]').forEach(el => {
        const key = el.getAttribute('data-i18n-title');
        el.setAttribute('title', t(key));
      });
      // 更新 document.title（若有 data-i18n on <title>）
      const titleEl = document.querySelector('title[data-i18n]');
      if (titleEl) document.title = t(titleEl.getAttribute('data-i18n'));
      // 更新語言按鈕樣式
      document.querySelectorAll('.lang-switch button').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-lang') === currentLang);
      });
    }

    /* ---------- items 資料與建立（保留原本） ---------- */
    const itemsData = [
      { img: 'https://images4.imagebam.com/8f/2d/05/ME19HW5Z_o.png', cost: 95 },
      { img: 'https://images4.imagebam.com/88/fd/c5/ME19HW6I_o.png', cost: 95 },
      { img: 'https://images4.imagebam.com/52/a4/20/ME19HW6X_o.png', cost: 85 },
      { img: 'https://images4.imagebam.com/9a/3b/ac/ME19HW6G_o.png', cost: 70 },
      { img: 'https://images4.imagebam.com/12/64/9a/ME19HW6E_o.png', cost: 65 },
      { img: 'https://images4.imagebam.com/61/e7/c2/ME19HW6Q_o.png', cost: 60 },
      { img: 'https://images4.imagebam.com/ee/cd/63/ME19HW65_o.png', cost: 60 },
      { img: 'https://images4.imagebam.com/bb/31/51/ME19HW71_o.png', cost: 55 },
      { img: 'https://images4.imagebam.com/c4/6e/b6/ME19HW61_o.png', cost: 45 },
      { img: 'https://images4.imagebam.com/94/3b/60/ME19HW6T_o.png', cost: 45 },
      { img: 'https://images4.imagebam.com/d1/d8/49/ME19HW6A_o.png', cost: 45 },
      { img: 'https://images4.imagebam.com/15/99/40/ME19HW6U_o.png', cost: 36 },
      { img: 'https://images4.imagebam.com/0f/f0/bb/ME19HW6Z_o.png', cost: 35 },
      { img: 'https://images4.imagebam.com/97/a3/27/ME19HW74_o.png', cost: 35 },
      { img: 'https://images4.imagebam.com/41/ba/a6/ME19HW6M_o.png', cost: 35 },
      { img: 'https://images4.imagebam.com/2c/76/71/ME19HW6K_o.png', cost: 30 },
      { img: 'https://images4.imagebam.com/28/76/d1/ME19HW6O_o.png', cost: 30 },
      { img: 'https://images4.imagebam.com/a4/3c/a1/ME19HW63_o.png', cost: 25 },
      { img: 'https://images4.imagebam.com/6c/bf/21/ME19HW68_o.png', cost: 25 },
      { img: 'https://images4.imagebam.com/29/e2/29/ME19HW60_o.png', cost: 25 },
      { img: 'https://images4.imagebam.com/d7/d1/ec/ME19HW6C_o.png', cost: 20 }
    ];

    const itemsEl = document.getElementById('items');
    itemsData.forEach(it => {
      const div = document.createElement('div');
      div.className = 'item';
      // 使用翻譯 key cost_title，並在建立時用當前語言產生 title
      const titleText = `${t('cost_label')} ${it.cost}`;
      div.innerHTML = `<img src="${it.img}" title="${titleText}">`;
      div.addEventListener('click', () => {
        document.querySelectorAll('.item').forEach(e => e.classList.remove('active'));
        div.classList.add('active');
        document.getElementById('cost').value = it.cost;
        syncSellFromMarkup();
        calc();
      });
      itemsEl.appendChild(div);
    });

    /* ---------- 元件參考 ---------- */
    const costEl = document.getElementById('cost');
    const sellREl = document.getElementById('sell_r');
    const markupRInput = document.getElementById('markup_r');
    const markupBInput = document.getElementById('markup_b');
    const taxBInput = document.getElementById('tax_b');
    const bonusBInput = document.getElementById('bonus_b');

    /* ---------- 同步與計算（保留原本邏輯，但動態字串使用 t()） ---------- */
    let isSyncing = false;

    sellREl.addEventListener('input', () => {
      if (isSyncing) return;
      isSyncing = true;
      const cost = parseFloat(costEl.value) || 0;
      const sell = parseFloat(sellREl.value) || 0;
      if (cost <= 0) {
        markupRInput.value = '';
      } else {
        const mr = (sell / cost - 1) * 100;
        markupRInput.value = isFinite(mr) ? mr.toFixed(4).replace(/\.?0+$/, '') : '';
      }
      calc();
      isSyncing = false;
    });

    markupRInput.addEventListener('input', () => {
      if (isSyncing) return;
      isSyncing = true;
      syncSellFromMarkup();
      calc();
      isSyncing = false;
    });

    costEl.addEventListener('input', () => {
      if (isSyncing) return;
      isSyncing = true;
      syncSellFromMarkup();
      calc();
      isSyncing = false;
    });

    function syncSellFromMarkup() {
      const cost = parseFloat(costEl.value) || 0;
      const mr = (parseFloat(markupRInput.value) || 0) / 100;
      if (cost <= 0) {
        sellREl.value = '';
      } else {
        const sell = cost * (1 + mr);
        sellREl.value = isFinite(sell) ? sell.toFixed(2).replace(/\.?0+$/, '') : '';
      }
    }

    function fmtNumber(n) {
      // 依語言格式化整數（無小數）
      try {
        return new Intl.NumberFormat(currentLang, { maximumFractionDigits: 0 }).format(n);
      } catch (e) {
        return Math.round(n).toString();
      }
    }

    function calc() {
      const cost = parseFloat(costEl.value) || 0;
      const sell_r = parseFloat(sellREl.value);
      const mr = (parseFloat(markupRInput.value) || 0) / 100;
      const tr = 11 / 100;
      const sell_r_effective = isFinite(sell_r) && sellREl.value !== '' ? sell_r : (cost * (1 + mr));
      const income_r_raw = sell_r_effective * (1 - tr);
      const income_r = Math.round(income_r_raw);

      const mb_input = (parseFloat(markupBInput.value) || 0) / 100;
      const tb = (parseFloat(taxBInput.value) || 0) / 100;
      const bb = (parseFloat(bonusBInput.value) || 0) / 100;

      const sell_b_input = cost * (1 + mb_input);
      const afterTax_b_input = sell_b_input * (1 - tb);
      const income_b_input_raw = afterTax_b_input * (1 + bb);
      const income_b_input = Math.round(income_b_input_raw);

      const resultREl = document.getElementById('result_r');
      const resultBEl = document.getElementById('result_b');

      const rIsHigher = income_r > income_b_input;
      const bIsHigher = income_b_input > income_r;

      // 使用 t() 產生動態 HTML（並格式化數字）
      const rHtml = t('sell_info_r', {
        price: fmtNumber(sell_r_effective),
        cls: rIsHigher ? 'highlight' : '',
        income: fmtNumber(income_r)
      });
      const bHtml = t('sell_info_b', {
        price: fmtNumber(sell_b_input),
        cls: bIsHigher ? 'highlight' : '',
        income: fmtNumber(income_b_input)
      });

      resultREl.innerHTML = rHtml;
      resultBEl.innerHTML = bHtml;

      const baDiv = document.getElementById('baUp');
      const baDiv2 = document.getElementById('baUp2');

      const denom = cost * (1 - tb) * (1 + bb);
      if (cost <= 0 || denom === 0) {
        baDiv.textContent = t('ba_equal_cost');
        baDiv2.textContent = t('ba_check');
      } else {
        const ba = (income_r_raw / denom) - 1;
        const baPercent = ba * 100;
        baDiv.textContent = `${t('ba_equal_cost').split('≈')[0]}≈ ${Math.round(baPercent)} %`;
        baDiv2.innerHTML = t('ba_basis', {
          tax: (tb * 100).toFixed(1),
          bonus: (bb * 100).toFixed(1)
        });
      }
    }

    ['markup_b', 'tax_b', 'bonus_b'].forEach(id => {
      document.getElementById(id).addEventListener('input', calc);
    });

    /* ---------- 語言切換事件 ---------- */
    document.getElementById('btn-zh').addEventListener('click', () => {
      currentLang = 'zh-TW';
      localStorage.setItem('lang', currentLang);
      // 更新所有靜態翻譯與 items 圖片 title
      applyTranslations();
      // 更新 items img title（因為 title 含成本數字）
      document.querySelectorAll('.item img').forEach((img, idx) => {
        img.title = `${t('cost_label')} ${itemsData[idx].cost}`;
      });
      calc();
    });

    document.getElementById('btn-en').addEventListener('click', () => {
      currentLang = 'en';
      localStorage.setItem('lang', currentLang);
      applyTranslations();
      document.querySelectorAll('.item img').forEach((img, idx) => {
        img.title = `${t('cost_label')} ${itemsData[idx].cost}`;
      });
      calc();
    });

    /* ---------- 初始化 ---------- */
    window.addEventListener('load', () => {
      applyTranslations();
      syncSellFromMarkup();
      calc();
    });
  </script>
</body>

</html>
